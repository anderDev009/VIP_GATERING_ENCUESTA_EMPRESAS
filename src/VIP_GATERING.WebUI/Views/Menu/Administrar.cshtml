@using Microsoft.AspNetCore.Mvc.Rendering
@model VIP_GATERING.WebUI.Models.MenuEdicionVM
@{
    ViewData["Title"] = "Administrar menu";
}
<h1 class="text-2xl font-semibold mb-1">Administrar menu semanal</h1>

<form method="get" class="page-panel mb-6 flex items-end gap-3">
    <input type='hidden' name='empresaId' value='@Model.EmpresaId' />
    <input type='hidden' name='sucursalId' value='@Model.SucursalId' />
    <div>
        <label class="block text-sm text-slate-600">Semana (elige cualquier dia)</label>
        <input type="date" name="fecha" value="@Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")" class="border rounded p-2" />
    </div>
    <button class="btn-outline">Ir</button>
</form>

<div class="page-panel mb-4">
    <div class="meta-row">
        <span class="meta-pill">Alcance: @Model.OrigenScope</span>
        <span class="meta-pill meta-pill--ghost">Empresa: @Model.EmpresaNombre</span>
        @if (Model.SucursalId != null)
        {
            <span class="meta-pill">Filial: @Model.SucursalNombre</span>
        }
        <span class="meta-pill meta-pill--accent">
            Semana @Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd") a @Model.FechaTermino.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")
        </span>
    </div>
</div>

<form method="get" class="page-panel mb-6 grid md:grid-cols-4 gap-3 items-end">
    <input type='hidden' name='fecha' value='@Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")' />
    <div>
        <label class="block text-sm text-slate-600">Empresa</label>
        <select name="empresaId" class="border rounded p-2 w-full">
            @foreach (var e in Model.Empresas)
            {
                if (Model.EmpresaId == e.id) {<option selected value="@e.id">@e.nombre</option>} else {<option value="@e.id">@e.nombre</option>}
            }
        </select>
    </div>
    <div>
        <label class="block text-sm text-slate-600">Filial (opcional)</label>
        <select id="sucursal-select" name="sucursalId" class="border rounded p-2 w-full">
            <option value="" data-empresa="">-- Global por Empresa --</option>
            @foreach (var s in Model.Sucursales)
            {
                if (Model.SucursalId == s.id) {<option selected value="@s.id" data-empresa="@s.empresaId">@s.nombre</option>} else {<option value="@s.id" data-empresa="@s.empresaId">@s.nombre</option>}
            }
        </select>
    </div>
    <div>
        <button class="btn-outline">Cambiar alcance</button>
    </div>
</form>

<div class="page-panel mb-4 space-y-2">
    <div class="flex flex-wrap gap-3 justify-between items-center">
        <div>
            <div class="text-sm text-slate-500">Estado del menu</div>
            <div class="text-lg font-semibold @(Model.EncuestaCerrada ? "text-red-600" : "text-emerald-600")">
                @(Model.EncuestaCerrada ? "Cerrado" : "Abierto")
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a class="btn-outline" target="_blank" rel="noopener"
               href="@Url.Action("VistaPrevia", new { inicio = Model.FechaInicio.ToString("yyyy-MM-dd"), fin = Model.FechaTermino.ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId, sucursalId = Model.SucursalId })">
                Vista previa
            </a>
        </div>
    </div>
    <div class="text-sm text-slate-600">
            Cierre autom&aacute;tico: @Model.FechaCierreAutomatica.ToString("dd/MM/yyyy")
            @if (Model.FechaCierreManual != null)
            {
                <div>Cierre manual: @Model.FechaCierreManual.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
            }
        </div>
        <div class="text-sm text-slate-600">
            Empleados con menu completo: <strong>@Model.EmpleadosCompletos</strong>
        </div>
        @if (User.IsInRole("Admin"))
        {
            <div class="flex gap-2">
                @if (!Model.EncuestaCerrada)
                {
                    <form asp-action="CerrarEncuesta" method="post" class="inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                        <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                        <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                        <button class="btn-outline" onclick="return confirm('Cerrar menu para esta semana?');">Cerrar menu</button>
                    </form>
                }
                else
                {
                    <form asp-action="ReabrirEncuesta" method="post" class="inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                        <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                        <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                        <button class="btn-outline">Reabrir menu</button>
                    </form>
                }
                <form asp-action="EliminarEncuesta" method="post" class="inline" onsubmit="return confirm('Eliminar menu y sus platos si no hay respuestas?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                    <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                    <button class="btn-outline" @(Model.PuedeEliminarEncuesta ? "" : "disabled title='No disponible: ya hay respuestas'")>Eliminar menu</button>
                </form>
            </div>
        }
    </div>
    <div class="flex justify-end gap-3 mt-2">
        <a class="btn-primary btn-sm" href="@Url.Action("Administrar", new { fecha = Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId })">
            Configurar men√∫ empresa completa
        </a>
    </div>
    @if (Model.EncuestaCerrada)
    {
        <div class="text-sm text-amber-700">Mientras el menu esta cerrado no se pueden modificar los platos.</div>
    }
</div>

<form asp-action="Guardar" method="post" class="space-y-4 menu-config">
    @Html.AntiForgeryToken()
    <div class="text-red-700 mb-2">@Html.ValidationSummary()</div>
    <input type="hidden" asp-for="FechaInicio" />
    <input type="hidden" asp-for="FechaTermino" />
    <input type="hidden" name="EmpresaId" value="@Model.EmpresaId" />
    <input type="hidden" name="SucursalId" value="@Model.SucursalId" />

    <div class="page-panel page-panel--compact mb-4">
        <div class="panel-header">
            <div>
                <div class="panel-title">Adicionales fijos</div>
                <div class="panel-subtitle">Se cobran 100% al empleado y aplican a todos los dias/horarios de este menu.</div>
            </div>
            @if (Model.EncuestaCerrada)
            {
                <span class="chip chip--muted">Menu cerrado</span>
            }
        </div>
        <div class="addon-field addon-field--split">
            <div class="addon-field__meta">
                <label>Selecciona los adicionales disponibles</label>
                <div class="addon-field__hint">Tip: escribe para filtrar y usa Enter para elegir multiples.</div>
            </div>
            <div class="addon-field__control">
                <select id="adicionales-select" name="AdicionalesIds" multiple class="w-full" @(Model.EncuestaCerrada ? "disabled" : "")>
                    @foreach (var o in Model.Opciones)
                    {
                        if (Model.AdicionalesIds != null && Model.AdicionalesIds.Contains(o.Id))
                        {
                            <option value="@o.Id" selected>@o.Nombre</option>
                        }
                        else
                        {
                            <option value="@o.Id">@o.Nombre</option>
                        }
                    }
                </select>
            </div>
        </div>
    </div>

    @{
        var dias = Model.Dias;
        var tabs = (Model.HorariosPermitidos ?? Array.Empty<VIP_GATERING.Domain.Entities.Horario>())
            .Select(h => h.Nombre)
            .Where(n => !string.IsNullOrWhiteSpace(n))
            .ToArray();
        var diasConIndice = dias.Select((d, idx) => new
        {
            Dia = d,
            Index = idx,
            Tab = tabs.FirstOrDefault(t => string.Equals(t, d.HorarioNombre, StringComparison.OrdinalIgnoreCase))
        }).Where(x => x.Tab != null).ToList();
    }
    @if (tabs.Length == 0)
    {
        <div class="alert alert-warning mb-4">No hay tandas habilitadas para esta empresa o filial. Configura las tandas en Filiales.</div>
    }
    <div class="tab-switch tab-switch--panel mb-4 @(tabs.Length == 0 ? "hidden" : "")">
        <div class="tab-switch__label">Tandas</div>
        <div class="tab-switch__group" id="tabs-horario">
            @for (var i = 0; i < tabs.Length; i++)
            {
                var tabId = $"tab-{tabs[i].ToLowerInvariant()}";
                <button type="button" class="tab-pill" data-tab-target="@tabId">@tabs[i]</button>
            }
        </div>
    </div>

    @if (tabs.Length > 0)
    {
        @for (var t = 0; t < tabs.Length; t++)
        {
            var tabId = $"tab-{tabs[t].ToLowerInvariant()}";
            var items = diasConIndice.Where(x => x.Tab == tabs[t]).ToList();
            <div id="@tabId" class="tab-panel @(t == 0 ? "is-active" : "") space-y-4" data-tab-panel>
                @if (items.Count == 0)
                {
                    <div class="empty-state">No hay platos configurados para este horario.</div>
                }
                else
                {
                    <div class="overflow-x-auto">
                        <table class="menu-table">
                            <thead>
                                <tr>
                                    <th>D&iacute;a</th>
                                    <th>Plato A</th>
                                    <th>Plato B</th>
                                    <th>Plato C</th>
                                    <th>Plato D</th>
                                    <th>Plato E</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in items)
                                {
                                    var d = item.Dia;
                                    var i = item.Index;
                                    var horarioId = d.HorarioId;
                                    var opcionesHorario = Model.Opciones
                                        .OrderBy(o => o.Nombre)
                                        .ToList();
                                    <tr data-card>
                                        <td class="menu-daycell">
                                            <div class="menu-day-title">
                                                <span>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetDayName(d.DiaSemana)</span>
                                                <span class="menu-day-meta">
                                                    <span class="icon-dot icon-dot--teal"></span>
                                                    @d.HorarioNombre
                                                </span>
                                            </div>
                                            <div class="menu-day-actions">
                                                <label class="text-xs text-slate-500">Platos habilitados</label>
                                                <select name="Dias[@i].OpcionesMaximas" class="border rounded p-2 max-w-[5.5rem]" data-max-select @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                    @for (var m = 1; m <= 5; m++)
                                                    {
                                                        if (d.OpcionesMaximas == m) { <option selected value="@m">@m</option>; }
                                                        else { <option value="@m">@m</option>; }
                                                    }
                                                </select>
                                            </div>
                                            <input type="hidden" name="Dias[@i].OpcionMenuId" value="@d.OpcionMenuId" />
                                        </td>
                                        <td class="menu-option-cell" data-slot="1">
                                            <select name="Dias[@i].A" class="w-full border rounded p-2" aria-label="Plato A" @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                <option value="">-- Sin plato --</option>
                                                @foreach (var o in opcionesHorario)
                                                {
                                                    if (d.A.HasValue && d.A.Value == o.Id)
                                                    {
                                                        <option selected value="@o.Id">@o.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@o.Id">@o.Nombre</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                        <td class="menu-option-cell" data-slot="2">
                                            <select name="Dias[@i].B" class="w-full border rounded p-2" aria-label="Plato B" @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                <option value="">-- Sin plato --</option>
                                                @foreach (var o in opcionesHorario)
                                                {
                                                    if (d.B.HasValue && d.B.Value == o.Id)
                                                    {
                                                        <option selected value="@o.Id">@o.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@o.Id">@o.Nombre</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                        <td class="menu-option-cell" data-slot="3">
                                            <select name="Dias[@i].C" class="w-full border rounded p-2" aria-label="Plato C" @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                <option value="">-- Sin plato --</option>
                                                @foreach (var o in opcionesHorario)
                                                {
                                                    if (d.C.HasValue && d.C.Value == o.Id)
                                                    {
                                                        <option selected value="@o.Id">@o.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@o.Id">@o.Nombre</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                        <td class="menu-option-cell" data-slot="4">
                                            <select name="Dias[@i].D" class="w-full border rounded p-2" aria-label="Plato D" @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                <option value="">-- Sin plato --</option>
                                                @foreach (var o in opcionesHorario)
                                                {
                                                    if (d.D.HasValue && d.D.Value == o.Id)
                                                    {
                                                        <option selected value="@o.Id">@o.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@o.Id">@o.Nombre</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                        <td class="menu-option-cell" data-slot="5">
                                            <select name="Dias[@i].E" class="w-full border rounded p-2" aria-label="Plato E" @(Model.EncuestaCerrada ? "disabled data-locked=\"1\"" : "")>
                                                <option value="">-- Sin plato --</option>
                                                @foreach (var o in opcionesHorario)
                                                {
                                                    if (d.E.HasValue && d.E.Value == o.Id)
                                                    {
                                                        <option selected value="@o.Id">@o.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@o.Id">@o.Nombre</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }
    }

    <div class="flex items-center gap-3">
        <a class="btn-outline" href="@Url.Action("Administrar", new { fecha = Model.FechaInicio.ToDateTime(TimeOnly.MinValue).AddDays(-7).ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId, sucursalId = Model.SucursalId })">Semana anterior</a>
        <button class="btn-primary" @(Model.EncuestaCerrada ? "disabled" : "")>Guardar todo</button>
        <a class="btn-outline" href="@Url.Action("Administrar", new { fecha = Model.FechaInicio.ToDateTime(TimeOnly.MinValue).AddDays(7).ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId, sucursalId = Model.SucursalId })">Siguiente semana</a>
    </div>
</form>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" />
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
    (() => {
        const sel = document.getElementById('adicionales-select');
        if (sel && typeof TomSelect !== 'undefined') {
            const isDisabled = sel.hasAttribute('disabled');
            const ts = new TomSelect(sel, {
                plugins: ['remove_button'],
                maxItems: null,
                persist: false,
                create: false,
                placeholder: 'Selecciona adicionales...',
                render: {
                    option: (data, escape) => `<div class="ts-option-inner">${escape(data.text)}</div>`,
                    item: (data, escape) => `<div class="ts-item-inner">${escape(data.text)}</div>`
                }
            });
            if (isDisabled) ts.disable();
        }
    })();
</script>

<script>
    (() => {
        const empresaSelect = document.querySelector('select[name="empresaId"]');
        const sucursalSelect = document.getElementById('sucursal-select');
        if (!empresaSelect || !sucursalSelect) return;

        const filterSucursales = () => {
            const empresaId = empresaSelect.value;
            let selectedOk = false;
            Array.from(sucursalSelect.options).forEach(option => {
                if (!option.value) {
                    option.hidden = false;
                    option.disabled = false;
                    return;
                }
                const match = option.dataset.empresa === empresaId;
                option.hidden = !match;
                option.disabled = !match;
                if (option.selected) selectedOk = match;
            });
            if (!selectedOk) {
                sucursalSelect.value = '';
            }
        };

        empresaSelect.addEventListener('change', filterSucursales);
        filterSucursales();
    })();
</script>

<script>
    (() => {
        // Ajustar slots segun OpcionesMaximas y limpiar los que queden fuera
        const cards = document.querySelectorAll('[data-card]');
        cards.forEach(card => {
            const maxSel = card.querySelector('[data-max-select]');
            const slots = card.querySelectorAll('[data-slot]');
            const updateSlots = () => {
                const max = parseInt(maxSel?.value || '3', 10);
                slots.forEach(slot => {
                    const slotNum = parseInt(slot.getAttribute('data-slot') || '0', 10);
                    const select = slot.querySelector('select');
                    const isLocked = select?.getAttribute('data-locked') === '1';
                    if (slotNum > max) {
                        slot.classList.add('menu-slot--disabled');
                        if (select && !isLocked) {
                            select.value = '';
                            select.disabled = true;
                        }
                    } else {
                        slot.classList.remove('menu-slot--disabled');
                        if (select && !isLocked) {
                            select.disabled = false;
                        }
                    }
                });
            };
            if (maxSel) {
                maxSel.addEventListener('change', updateSlots);
                updateSlots();
            }
        });

        // Tabs por horario
        const tabButtons = document.querySelectorAll('.tab-pill');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-tab-target');
                if (!targetId) return;
                document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.remove('is-active'));
                const target = document.getElementById(targetId);
                if (target) target.classList.add('is-active');
                tabButtons.forEach(b => b.classList.remove('is-active'));
                btn.classList.add('is-active');
            });
        });
        if (tabButtons.length > 0) tabButtons[0].classList.add('is-active');
    })();
</script>




