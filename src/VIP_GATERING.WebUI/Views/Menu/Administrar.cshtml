@using Microsoft.AspNetCore.Mvc.Rendering
@model VIP_GATERING.WebUI.Models.MenuEdicionVM
@{
    ViewData["Title"] = "Administrar menú";
}
<h1 class="text-2xl font-semibold mb-1">Administrar menú semanal</h1>

<form method="get" class="mb-6 flex items-end gap-3">
    <input type='hidden' name='empresaId' value='@Model.EmpresaId' />
    <input type='hidden' name='sucursalId' value='@Model.SucursalId' />
    <div>
        <label class="block text-sm text-slate-600">Semana (elige cualquier día)</label>
        <input type="date" name="fecha" value="@Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")" class="border rounded p-2" />
    </div>
    <button class="btn-outline">Ir</button>
</form>

<div class="mb-4 text-sm text-slate-600">
    Alcance: <span class="inline-block px-2 py-0.5 rounded border bg-white">@Model.OrigenScope</span>
    — Cliente: <strong>@Model.EmpresaNombre</strong>
    @if (Model.SucursalId != null)
    {
        <text> — Dependiente: <strong>@Model.SucursalNombre</strong></text>
    }
    <div class="text-xs text-slate-500">Semana @Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd") a @Model.FechaTermino.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")</div>
</div>

<form method="get" class="mb-6 p-4 bg-white border rounded grid md:grid-cols-4 gap-3 items-end">
    <input type='hidden' name='fecha' value='@Model.FechaInicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")' />
    <div>
        <label class="block text-sm text-slate-600">Cliente</label>
        <select name="empresaId" class="border rounded p-2 w-full">
            @foreach (var e in Model.Empresas)
            {
                if (Model.EmpresaId == e.id) {<option selected value="@e.id">@e.nombre</option>} else {<option value="@e.id">@e.nombre</option>}
            }
        </select>
    </div>
    <div>
        <label class="block text-sm text-slate-600">Dependiente (opcional)</label>
        <select name="sucursalId" class="border rounded p-2 w-full">
            <option value="">-- Global por cliente --</option>
            @foreach (var s in Model.Sucursales)
            {
                if (Model.SucursalId == s.id) {<option selected value="@s.id">@s.nombre</option>} else {<option value="@s.id">@s.nombre</option>}
            }
        </select>
    </div>
    <div>
        <button class="btn-outline">Cambiar alcance</button>
    </div>
</form>

<div class="mb-4 p-4 bg-white border rounded space-y-2">
        <div class="flex flex-wrap gap-3 justify-between items-center">
            <div>
                <div class="text-sm text-slate-500">Estado de encuesta</div>
                <div class="text-lg font-semibold @(Model.EncuestaCerrada ? "text-red-600" : "text-emerald-600")">
                    @(Model.EncuestaCerrada ? "Cerrada" : "Abierta")
            </div>
        </div>
        <div class="text-sm text-slate-600">
            Cierre autom&aacute;tico: @Model.FechaCierreAutomatica.ToString("dd/MM/yyyy")
            @if (Model.FechaCierreManual != null)
            {
                <div>Cierre manual: @Model.FechaCierreManual.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</div>
            }
        </div>
        <div class="text-sm text-slate-600">
            Empleados con encuesta completa: <strong>@Model.EmpleadosCompletos</strong>
        </div>
        @if (User.IsInRole("Admin"))
        {
            <div class="flex gap-2">
                @if (!Model.EncuestaCerrada)
                {
                    <form asp-action="CerrarEncuesta" method="post" class="inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                        <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                        <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                        <button class="btn-outline" onclick="return confirm('¿Cerrar encuesta para esta semana?');">Cerrar encuesta</button>
                    </form>
                }
                else
                {
                    <form asp-action="ReabrirEncuesta" method="post" class="inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                        <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                        <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                        <button class="btn-outline">Reabrir encuesta</button>
                    </form>
                }
                <form asp-action="EliminarEncuesta" method="post" class="inline" onsubmit="return confirm('Eliminar encuesta y sus opciones si no hay respuestas?');">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="inicio" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="empresaId" value="@Model.EmpresaId" />
                    <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                    <button class="btn-outline" @(Model.PuedeEliminarEncuesta ? "" : "disabled title='No disponible: ya hay respuestas'")>Eliminar encuesta</button>
                </form>
            </div>
        }
    </div>
    @if (Model.EncuestaCerrada)
    {
        <div class="text-sm text-amber-700">Mientras la encuesta esté cerrada no se pueden modificar las opciones.</div>
    }
</div>

<form asp-action="Guardar" method="post" class="space-y-4">
    @Html.AntiForgeryToken()
    <div class="text-red-700 mb-2">@Html.ValidationSummary()</div>
    <input type="hidden" asp-for="FechaInicio" />
    <input type="hidden" asp-for="FechaTermino" />
    <input type="hidden" name="EmpresaId" value="@Model.EmpresaId" />
    <input type="hidden" name="SucursalId" value="@Model.SucursalId" />

    @{
        var dias = Model.Dias;
    }
    <div class="mb-4 overflow-x-auto">
        <div class="flex gap-2" id="tabs-dias">
            @for (var i = 0; i < dias.Count; i++)
            {
                var label = $"{System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetDayName(dias[i].DiaSemana)} - {dias[i].HorarioNombre}";
                <button type="button"
                        class="px-3 py-1.5 border rounded-full text-sm bg-white hover:bg-slate-100"
                        data-tab-target="tab-@i">@label</button>
            }
        </div>
    </div>

    @for (var i = 0; i < dias.Count; i++)
    {
        <div class="bg-white border rounded p-4 mb-3" data-card id="tab-@i" style="display:@(i==0 ? "block" : "none")">
            <input type="hidden" name="Dias[@i].OpcionMenuId" value="@dias[i].OpcionMenuId" />
            <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
                <div>
                    <div class="font-medium">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetDayName(dias[i].DiaSemana)</div>
                    <span class="text-xs uppercase tracking-wide bg-slate-100 text-slate-600 px-2 py-0.5 rounded">@dias[i].HorarioNombre</span>
                </div>
                <div class="text-sm text-slate-600 flex items-center gap-2">
                    <label class="whitespace-nowrap">Opciones habilitadas</label>
                    <select name="Dias[@i].OpcionesMaximas" class="border rounded p-2" data-max-select @(Model.EncuestaCerrada ? "disabled" : "")>
                        @for (var m = 1; m <= 5; m++)
                        {
                            if (dias[i].OpcionesMaximas == m) { <option selected value="@m">@m</option>; }
                            else { <option value="@m">@m</option>; }
                        }
                    </select>
                </div>
            </div>
            <div class="grid lg:grid-cols-5 md:grid-cols-3 sm:grid-cols-2 gap-3" data-slot-container>
                <div data-slot="1">
                    <label class="text-sm text-slate-600">Opcion A</label>
                    <select name="Dias[@i].A" class="w-full border rounded p-2" @(Model.EncuestaCerrada ? "disabled" : "")>
                        <option value="">-- Sin opcion --</option>
                        @foreach (var o in Model.Opciones)
                        {
                            if (dias[i].A.HasValue && dias[i].A.Value == o.Id)
                            {
                                <option selected value="@o.Id">@o.Nombre</option>
                            }
                            else
                            {
                                <option value="@o.Id">@o.Nombre</option>
                            }
                        }
                    </select>
                </div>
                <div data-slot="2">
                    <label class="text-sm text-slate-600">Opcion B</label>
                    <select name="Dias[@i].B" class="w-full border rounded p-2" @(Model.EncuestaCerrada ? "disabled" : "")>
                        <option value="">-- Sin opcion --</option>
                        @foreach (var o in Model.Opciones)
                        {
                            if (dias[i].B.HasValue && dias[i].B.Value == o.Id)
                            {
                                <option selected value="@o.Id">@o.Nombre</option>
                            }
                            else
                            {
                                <option value="@o.Id">@o.Nombre</option>
                            }
                        }
                    </select>
                </div>
                <div data-slot="3">
                    <label class="text-sm text-slate-600">Opcion C</label>
                    <select name="Dias[@i].C" class="w-full border rounded p-2" @(Model.EncuestaCerrada ? "disabled" : "")>
                        <option value="">-- Sin opcion --</option>
                        @foreach (var o in Model.Opciones)
                        {
                            if (dias[i].C.HasValue && dias[i].C.Value == o.Id)
                            {
                                <option selected value="@o.Id">@o.Nombre</option>
                            }
                            else
                            {
                                <option value="@o.Id">@o.Nombre</option>
                            }
                        }
                    </select>
                </div>
                <div data-slot="4">
                    <label class="text-sm text-slate-600">Opcion D</label>
                    <select name="Dias[@i].D" class="w-full border rounded p-2" @(Model.EncuestaCerrada ? "disabled" : "")>
                        <option value="">-- Sin opcion --</option>
                        @foreach (var o in Model.Opciones)
                        {
                            if (dias[i].D.HasValue && dias[i].D.Value == o.Id)
                            {
                                <option selected value="@o.Id">@o.Nombre</option>
                            }
                            else
                            {
                                <option value="@o.Id">@o.Nombre</option>
                            }
                        }
                    </select>
                </div>
                <div data-slot="5">
                    <label class="text-sm text-slate-600">Opcion E</label>
                    <select name="Dias[@i].E" class="w-full border rounded p-2" @(Model.EncuestaCerrada ? "disabled" : "")>
                        <option value="">-- Sin opcion --</option>
                        @foreach (var o in Model.Opciones)
                        {
                            if (dias[i].E.HasValue && dias[i].E.Value == o.Id)
                            {
                                <option selected value="@o.Id">@o.Nombre</option>
                            }
                            else
                            {
                                <option value="@o.Id">@o.Nombre</option>
                            }
                        }
                    </select>
                </div>
            </div>
        </div>
    }

    <div class="flex items-center gap-3">
        <a class="btn-outline" href="@Url.Action("Administrar", new { fecha = Model.FechaInicio.ToDateTime(TimeOnly.MinValue).AddDays(-7).ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId, sucursalId = Model.SucursalId })">Semana anterior</a>
        <button class="btn-primary" @(Model.EncuestaCerrada ? "disabled" : "")>Guardar todo</button>
        <a class="btn-outline" href="@Url.Action("Administrar", new { fecha = Model.FechaInicio.ToDateTime(TimeOnly.MinValue).AddDays(7).ToString("yyyy-MM-dd"), empresaId = Model.EmpresaId, sucursalId = Model.SucursalId })">Siguiente semana</a>
    </div>
</form>

<script>
    (() => {
        // Mostrar/ocultar slots según OpcionesMaximas y limpiar los que queden fuera
        const cards = document.querySelectorAll('[data-card]');
        cards.forEach(card => {
            const maxSel = card.querySelector('[data-max-select]');
            const slots = card.querySelectorAll('[data-slot]');
            const updateSlots = () => {
                const max = parseInt(maxSel?.value || '3', 10);
                slots.forEach(slot => {
                    const slotNum = parseInt(slot.getAttribute('data-slot') || '0', 10);
                    const select = slot.querySelector('select');
                    if (slotNum > max) {
                        slot.classList.add('hidden');
                        if (select) select.value = '';
                    } else {
                        slot.classList.remove('hidden');
                    }
                });
            };
            if (maxSel) {
                maxSel.addEventListener('change', updateSlots);
                updateSlots();
            }
        });

        // Tabs por día/horario
        const tabButtons = document.querySelectorAll('[data-tab-target]');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-tab-target');
                if (!targetId) return;
                document.querySelectorAll('[data-card]').forEach(c => c.style.display = 'none');
                const target = document.getElementById(targetId);
                if (target) target.style.display = 'block';
                tabButtons.forEach(b => b.classList.remove('bg-slate-200'));
                btn.classList.add('bg-slate-200');
            });
        });
        if (tabButtons.length > 0) tabButtons[0].classList.add('bg-slate-200');
    })();
</script>
