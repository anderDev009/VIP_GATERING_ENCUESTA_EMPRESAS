@model VIP_GATERING.WebUI.Models.SemanaEmpleadoVM
@{
    ViewData["Title"] = "Editar selecciones (jefe)";
}

<section class="page-panel space-y-4 mb-4">
    <div class="meta-row">
        <span class="meta-pill meta-pill--accent">VIP</span>
        <span class="meta-pill">Empresa: @Model.EmpresaNombre</span>
        @if (!string.IsNullOrWhiteSpace(Model.SucursalNombre))
        {
            <span class="meta-pill meta-pill--ghost">Filial: @Model.SucursalNombre</span>
        }
        <span class="meta-pill">Origen: @Model.OrigenMenu</span>
        @if (!string.IsNullOrWhiteSpace(Model.EmpleadoCodigo))
        {
            <span class="meta-pill meta-pill--ghost">Codigo empleado: @Model.EmpleadoCodigo</span>
        }
    </div>
    <div class="panel-header">
        <div>
            <p class="eyebrow">Editar selecciones</p>
            <p class="panel-title">@Model.EmpleadoNombre</p>
            <p class="panel-subtitle">Semana @Model.FechaInicio.ToString("yyyy-MM-dd") a @Model.FechaTermino.ToString("yyyy-MM-dd")</p>
        </div>
        <div class="text-right">
            <p class="eyebrow">Total empleado</p>
            <p class="summary-value">@Model.TotalEmpleado.ToString("C")</p>
            @if (Model.EsVistaAdministrador && Model.TotalEmpresa != null)
            {
                <p class="summary-hint">Costo empresa: @Model.TotalEmpresa.Value.ToString("C")</p>
            }
        </div>
    </div>
</section>

@if (!string.IsNullOrWhiteSpace(Model.MensajeBloqueo))
{
    <div class="p-3 rounded bg-amber-50 border border-amber-200 text-amber-800 mb-4">
        @Model.MensajeBloqueo
    </div>
}

<form asp-action="GuardarSemanaJefe" method="post" class="space-y-4">
    @Html.AntiForgeryToken()
    <input type="hidden" name="empleadoId" value="@Model.EmpleadoId" />
    <input type="hidden" name="MenuId" value="@Model.MenuId" />
@{
    var diasConIndice = Model.Dias.Select((d, idx) => new { Dia = d, Index = idx }).ToList();
    var grupos = diasConIndice.GroupBy(x => string.IsNullOrWhiteSpace(x.Dia.HorarioNombre) ? "General" : x.Dia.HorarioNombre!).ToList();
}
    <section class="page-panel space-y-4">
        <div class="tab-switch">
            <div class="tab-switch__label">Tandas</div>
            <div class="tab-switch__group" id="tabs-horario">
                @for (var gi = 0; gi < grupos.Count; gi++)
                {
                    var g = grupos[gi];
                    var tabId = $"tab-{gi}";
                    <button type="button" class="tab-pill" data-tab-target="@tabId">@g.Key</button>
                }
            </div>
        </div>

        @for (var gi = 0; gi < grupos.Count; gi++)
        {
            var g = grupos[gi];
            var tabId = $"tab-{gi}";
            <div id="@tabId" class="tab-panel @(gi == 0 ? "is-active" : "") space-y-3" data-tab-panel>
                @foreach (var item in g)
                {
                    var d = item.Dia;
                    var i = item.Index;
                    var opcionesDia = new[]
                    {
                        new { Clave = "A", Nombre = d.A, Imagen = d.ImagenA },
                        new { Clave = "B", Nombre = d.B, Imagen = d.ImagenB },
                        new { Clave = "C", Nombre = d.C, Imagen = d.ImagenC },
                        new { Clave = "D", Nombre = d.D, Imagen = d.ImagenD },
                        new { Clave = "E", Nombre = d.E, Imagen = d.ImagenE }
                    }.Take(d.OpcionesMaximas <= 0 ? 3 : d.OpcionesMaximas).ToList();

                    <div class="card">
                        <div class="px-4 py-3 border-b font-medium">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetDayName(d.DiaSemana) - @d.HorarioNombre</div>
                        <div class="p-4">
                            @if (!opcionesDia.Any(o => !string.IsNullOrWhiteSpace(o.Nombre)))
                            {
                                <div class="text-slate-500">Aun no hay platos definidos para este dia.</div>
                            }
                            else
                            {
                                <input type="hidden" name="Dias[@i].OpcionMenuId" value="@d.OpcionMenuId" />
                                <div class="grid lg:grid-cols-5 md:grid-cols-3 sm:grid-cols-2 gap-3">
                                    @foreach (var opc in opcionesDia)
                                    {
                                        var seleccionada = d.Seleccion == opc.Clave[0];
                                        <label class="option-card @((seleccionada) ? "option-card--active" : "")">
                                            <input type="radio"
                                                   name="Dias[@i].Seleccion"
                                                   value="@opc.Clave"
                                                   class="option-card__input"
                                                   @(seleccionada ? "checked" : "") />
                                            <div class="option-card__content">
                                                <div class="option-card__header">
                                                    <span class="chip chip--muted">Plato @opc.Clave</span>
                                                    @if (seleccionada)
                                                    {
                                                        <span class="chip chip--success">Seleccionado</span>
                                                    }
                                                </div>
                                                <div class="option-card__title">@(!string.IsNullOrWhiteSpace(opc.Nombre) ? opc.Nombre : "Sin definir")</div>
                                                <div class="option-card__meta">@d.HorarioNombre</div>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(opc.Imagen))
                                            {
                                                <div class="option-card__thumb">
                                                    <img src="@opc.Imagen" alt="Plato @opc.Clave de @d.HorarioNombre" />
                                                </div>
                                            }
                                        </label>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </section>
    <div class="form-actions">
        <button class="btn-primary">Guardar cambios</button>
        <a asp-action="Semana" asp-route-id="@Model.EmpleadoId" class="btn-outline">Cancelar</a>
    </div>
</form>

@section Scripts {
    <script src="~/js/empleados-editar-semana.js" defer></script>
}

