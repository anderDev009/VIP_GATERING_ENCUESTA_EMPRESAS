@model VIP_GATERING.Domain.Entities.Empleado
@{
    ViewData["Title"] = "Editar empleado";
    var empresas = (IEnumerable<VIP_GATERING.Domain.Entities.Empresa>)ViewBag.Empresas;
    var sucursales = (IEnumerable<VIP_GATERING.Domain.Entities.Sucursal>)ViewBag.Sucursales;
    var sucursalesAsignadasIds = (IEnumerable<Guid>)(ViewBag.SucursalesAsignadasIds ?? new List<Guid>());
}
<h1 class="text-2xl font-semibold mb-4">Editar empleado</h1>

<form asp-action="Edit" method="post" class="space-y-4 card max-w-lg">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <div>
        <label class="block text-sm">Cliente</label>
        <select class="w-full border rounded p-2" id="selEmpresa">
            @foreach (var e in empresas)
            {
                if (Model.Sucursal?.EmpresaId == e.Id) {<option selected value="@e.Id">@e.Nombre</option>} else {<option value="@e.Id">@e.Nombre</option>}
            }
        </select>
    </div>
    <div>
        <label class="block text-sm">Dependiente</label>
        <select asp-for="SucursalId" class="w-full border rounded p-2" id="selSucursal">
            @foreach (var s in sucursales)
            {
                if (Model.SucursalId == s.Id) {<option selected value="@s.Id" data-empresa="@s.EmpresaId">@s.Nombre</option>} else {<option value="@s.Id" data-empresa="@s.EmpresaId">@s.Nombre</option>}
            }
        </select>
    </div>
    <div>
        <label class="block text-sm">Dependientes adicionales (opcional)</label>
        <select name="sucursalesAsignadas" multiple size="6" class="w-full border rounded p-2" id="selSucursalesAsignadas">
            @foreach (var s in sucursales)
            {
                var selected = sucursalesAsignadasIds.Contains(s.Id);
                <option value="@s.Id" data-empresa="@s.EmpresaId" selected="@(selected ? "selected" : null)">@s.Nombre</option>
            }
        </select>
        <div class="text-xs text-slate-500 mt-1">Estas sucursales también podrán recibir el pedido del empleado.</div>
    </div>
    <div>
        <label class="block text-sm">Estado</label>
        <select asp-for="Estado" class="w-full border rounded p-2">
            <option value="0" selected="@(Model.Estado==VIP_GATERING.Domain.Entities.EmpleadoEstado.Habilitado)">Habilitado</option>
            <option value="1" selected="@(Model.Estado==VIP_GATERING.Domain.Entities.EmpleadoEstado.Suspendido)">Suspendido</option>
            <option value="2" selected="@(Model.Estado==VIP_GATERING.Domain.Entities.EmpleadoEstado.Desactivado)">Desactivado</option>
        </select>
    </div>
    <div>
        <label class="block text-sm">Código</label>
        <input asp-for="Codigo" class="w-full border rounded p-2" />
    </div>
    <div>
        <label class="block text-sm">Nombre</label>
        <input asp-for="Nombre" class="w-full border rounded p-2" />
    </div>
    <div class="flex items-center gap-2">
        <input asp-for="EsSubsidiado" type="checkbox" class="border rounded" id="chkSubsidio" />
        <label for="chkSubsidio" class="text-sm">Empleado subsidiado</label>
    </div>
    <div class="text-xs text-slate-500 -mt-2">Si está desmarcado, el empleado paga el monto completo según el menú.</div>
    <div class="flex gap-2">
        <button class="btn-primary">Guardar</button>
        <a asp-action="Index" class="btn-outline">Cancelar</a>
    </div>
</form>
<script>
    (function(){
        const emp = document.getElementById('selEmpresa');
        const suc = document.getElementById('selSucursal');
        const sucMulti = document.getElementById('selSucursalesAsignadas');
        function filter(){
            const v = emp.value;
            for(const opt of suc.options){
                if(!opt.value) continue;
                const show = !opt.dataset.empresa || opt.dataset.empresa === v;
                opt.style.display = show ? '' : 'none';
            }
            if (sucMulti) {
                for (const opt of sucMulti.options) {
                    if (!opt.value) continue;
                    const show = !opt.dataset.empresa || opt.dataset.empresa === v;
                    opt.style.display = show ? '' : 'none';
                    if (!show) opt.selected = false;
                }
            }
            syncMultiDisable();
        }
        function syncMultiDisable(){
            if (!sucMulti) return;
            const primary = suc.value;
            for (const opt of sucMulti.options) {
                if (opt.value === primary) {
                    opt.disabled = true;
                    opt.selected = false;
                } else {
                    opt.disabled = false;
                }
            }
        }
        emp.addEventListener('change', filter); filter();
        suc.addEventListener('change', syncMultiDisable); syncMultiDisable();
    })();
</script>
@{
    var usuarioExiste = (bool)(ViewBag.UsuarioExiste ?? false);
    var usuarioEmail = (string?)ViewBag.UsuarioEmail;
}
@if (User.IsInRole("Admin") || User.IsInRole("Empresa"))
{
    <div class="card max-w-lg mt-6">
        <h2 class="text-lg font-semibold mb-2">Cuenta de usuario</h2>
        @if (usuarioExiste)
        {
            <div class="text-sm text-green-700">Este empleado ya tiene usuario: <strong>@usuarioEmail</strong></div>
            <form asp-action="ResetPassword" method="post" class="mt-3 space-y-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <div>
                    <label class="block text-sm">Nueva contraseña</label>
                    <input type="password" name="newPassword" required minlength="8" class="border rounded p-2 w-full" placeholder="Mínimo 8 caracteres seguros" />
                </div>
                <div>
                    <label class="block text-sm">Confirmar nueva contraseña</label>
                    <input type="password" name="confirmPassword" required minlength="8" class="border rounded p-2 w-full" placeholder="Repite la contraseña" />
                </div>
                <div class="text-xs text-slate-500">Debe incluir mayúsculas, minúsculas, número y símbolo.</div>
                <button class="btn-outline">Resetear contraseña</button>
            </form>
            <div class="text-xs text-slate-500 mt-2">Se requerirá cambio de contraseña en el próximo inicio de sesión.</div>
        }
        else
        {
            <form asp-action="CrearUsuario" method="post" class="flex items-end gap-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <div>
                    <label class="block text-sm">Correo</label>
                    <input type="email" id="newUserEmail" name="email" required class="border rounded p-2" placeholder="empleado@correo.com" data-val="true" data-val-remote="Ya existe un usuario con ese correo." data-val-remote-url="@Url.Action("CheckEmailAvailable","Empleados")" data-val-remote-type="GET" />
                    <span class="text-xs" data-valmsg-for="email" data-valmsg-replace="true"></span>
                </div>
                <button class="btn-primary">Crear usuario</button>
            </form>
            <div class="text-xs text-slate-500 mt-2">Se asignará una contraseña temporal segura y el rol Empleado. Se pedirá cambio al iniciar sesión.</div>
        }
    </div>
}


@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function(){
            const input = document.getElementById('newUserEmail');
            if(!input) return;
            const msg = document.querySelector('[data-valmsg-for="email"]');
            function style(){
                const hasErr = input.classList.contains('input-validation-error');
                input.classList.toggle('border-red-500', hasErr);
                input.classList.toggle('border-green-500', !hasErr && input.value.length>0);
                if(msg){ msg.classList.toggle('text-red-600', hasErr); msg.classList.toggle('text-green-600', !hasErr && input.value.length>0 && msg.textContent===''); }
            }
            ['input','blur'].forEach(ev=> input.addEventListener(ev, function(){
                const form = input.closest('form');
                if (form && window.jQuery && jQuery(form).data('validator')) { jQuery(form).validate().element(input); }
                style();
            }));
            style();
        })();
    </script>
}
