@model VIP_GATERING.Domain.Entities.Empleado
@{
    ViewData["Title"] = "Nuevo empleado";
    var empresas = (IEnumerable<VIP_GATERING.Domain.Entities.Empresa>)ViewBag.Empresas;
    var sucursales = (IEnumerable<VIP_GATERING.Domain.Entities.Sucursal>)ViewBag.Sucursales;
    var localizaciones = (IEnumerable<VIP_GATERING.Domain.Entities.Localizacion>)(ViewBag.Localizaciones ?? new List<VIP_GATERING.Domain.Entities.Localizacion>());
    var localizacionAsignadaId = ViewBag.LocalizacionAsignadaId as int?;
    int? empresaSeleccionada = ViewBag.EmpresaId as int?;
    var successMessage = ViewBag.SuccessMessage ?? TempData["Success"];
    var passwordMessage = ViewBag.PasswordMessage ?? TempData["PasswordMessage"];
    var showPasswordModal = ViewBag.ShowPasswordModal is bool show && show;
    var passwordEmpleadoId = ViewBag.PasswordEmpleadoId as int?;
    var empresaLookup = empresas.ToDictionary(e => e.Id, e => e.Nombre);
    var usaPersonalizado = Model.SubsidioTipo != null || Model.SubsidioValor != null;
    var subsidioTipo = Model.SubsidioTipo ?? VIP_GATERING.Domain.Entities.SubsidioTipo.Porcentaje;
    var subsidioValor = Model.SubsidioValor ?? 75m;
}
<h1 class="text-2xl font-semibold mb-4 max-w-lg mx-auto">Nuevo empleado</h1>

<form asp-action="Create" method="post" class="space-y-4 card max-w-lg mx-auto">
    @Html.AntiForgeryToken()
    @if (successMessage != null)
    {
        <div class="rounded-2xl border border-emerald-200 bg-emerald-50 p-6 text-center text-emerald-900">
            <div class="text-2xl font-semibold">@successMessage</div>
            <div class="text-sm text-emerald-700 mt-1">Puedes continuar creando empleados.</div>
            @if (passwordMessage != null)
            {
                <div class="text-sm text-emerald-700 mt-2">@passwordMessage</div>
            }
        </div>
    }
    <div>
        <label class="block text-sm">Empresa</label>
        <select class="w-full border rounded p-2" id="selEmpresa">
            @foreach (var e in empresas)
            {
                <option value="@e.Id" selected="@(empresaSeleccionada == e.Id ? "selected" : null)">@e.Nombre</option>
            }
        </select>
    </div>
    <div>
        <label class="block text-sm">Filial</label>
        <select asp-for="SucursalId" class="w-full border rounded p-2" id="selSucursal">
            @foreach (var s in sucursales)
            {
                <option value="@s.Id" data-empresa="@s.EmpresaId">@s.Nombre</option>
            }
        </select>
    </div>
    <div>
        <label class="block text-sm">Localizacion por defecto (opcional)</label>
        <select name="localizacionAsignadaId" class="w-full" id="selLocalizacionesAsignadas">
            <option value="">-- Sin localizacion --</option>
            @foreach (var l in localizaciones)
            {
                var selected = localizacionAsignadaId.HasValue && localizacionAsignadaId.Value == l.Id;
                var empNombre = l.Sucursal != null && empresaLookup.TryGetValue(l.Sucursal.EmpresaId, out var empName) ? empName : string.Empty;
                var sucNombre = l.Sucursal?.Nombre ?? string.Empty;
                var etiqueta = string.IsNullOrWhiteSpace(sucNombre) ? l.Nombre : $"{sucNombre} - {l.Nombre}";
                <option value="@l.Id" data-sucursal="@l.SucursalId" data-empresa="@(l.Sucursal?.EmpresaId)" selected="@(selected ? "selected" : null)">@etiqueta</option>
            }
        </select>
        <div class="text-xs text-slate-500 mt-1">Se usara como sugerida al entrar al menu, pero el empleado podra cambiarla.</div>
    </div>
    <div>
        <label class="block text-sm">Codigo</label>
        <input asp-for="Codigo" class="w-full border rounded p-2" />
    </div>
    <div>
        <label class="block text-sm">Nombre</label>
        <input asp-for="Nombre" class="w-full border rounded p-2" />
    </div>
    <div class="flex items-center gap-2">
        <input asp-for="EsSubsidiado" type="checkbox" class="border rounded" id="chkSubsidio" />
        <label for="chkSubsidio" class="text-sm">Empleado subsidiado</label>
    </div>
    <div class="text-xs text-slate-500 -mt-2">Si esta desmarcado, el empleado paga el monto completo segun el menu.</div>
    <div class="mt-3">
        <label class="block text-sm font-semibold">Subsidio del empleado</label>
        <div class="flex flex-wrap gap-3 mt-1">
            <label class="flex items-center gap-2 text-sm">
                <input type="radio" name="subsidioEmpleadoScope" value="inherit" @(usaPersonalizado ? "" : "checked") />
                Usar regla de Empresa/Filial
            </label>
            <label class="flex items-center gap-2 text-sm">
                <input type="radio" name="subsidioEmpleadoScope" value="custom" @(usaPersonalizado ? "checked" : "") />
                Personalizado
            </label>
        </div>
    </div>
    <div id="subsidio-empleado-custom" class="grid md:grid-cols-3 gap-3 @(usaPersonalizado ? "" : "hidden")">
        <div>
            <label class="block text-sm">Tipo de subsidio</label>
            <select name="CustomEmpleadoSubsidioTipo" class="w-full border rounded p-2">
                <option value="0" selected="@(subsidioTipo == VIP_GATERING.Domain.Entities.SubsidioTipo.Porcentaje ? "selected" : null)">Porcentaje</option>
                <option value="1" selected="@(subsidioTipo == VIP_GATERING.Domain.Entities.SubsidioTipo.MontoFijo ? "selected" : null)">Monto fijo</option>
            </select>
        </div>
        <div>
            <label class="block text-sm">Valor del subsidio</label>
            <input name="CustomEmpleadoSubsidioValor" type="number" min="0" step="0.01" value="@subsidioValor" class="w-full border rounded p-2" />
        </div>
    </div>
    <div class="text-xs text-slate-500 -mt-1">Si seleccionas personalizado, se aplica este subsidio al empleado aunque la Empresa tenga otro.</div>
    <div class="flex gap-2">
        <button class="btn-primary">Guardar</button>
        <a asp-action="Index" class="btn-outline">Cancelar</a>
    </div>
</form>

@if (showPasswordModal && passwordEmpleadoId.HasValue)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2 class="text-lg font-semibold mb-2">Asignar contrasena</h2>
            <p class="text-sm text-slate-600 mb-4">El usuario se creo sin contrasena automatica. Asigna una ahora.</p>
            <form asp-action="ResetPassword" method="post" class="space-y-2">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@passwordEmpleadoId.Value" />
                <input type="hidden" name="stayOnCreate" value="true" />
                <input type="hidden" name="empresaId" value="@empresaSeleccionada" />
                <input type="hidden" name="sucursalId" value="@Model.SucursalId" />
                <div>
                    <label class="block text-sm">Nueva contrasena</label>
                    <input type="password" name="newPassword" required minlength="6" class="border rounded p-2 w-full" placeholder="Minimo 6 caracteres" />
                </div>
                <div>
                    <label class="block text-sm">Confirmar contrasena</label>
                    <input type="password" name="confirmPassword" required minlength="6" class="border rounded p-2 w-full" placeholder="Repite la contrasena" />
                </div>
                <div class="text-xs text-slate-500">Debe tener al menos 6 caracteres de longitud.</div>
                <div class="flex justify-end gap-2 pt-2">
                    <button class="btn-primary" type="submit">Guardar contrasena</button>
                </div>
            </form>
        </div>
    </div>
}

@section Styles {
    <link rel="stylesheet" href="~/vendor/tom-select/tom-select.css" />
    <style>
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 24px;
        }
        .modal-card {
            width: 100%;
            max-width: 420px;
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
        }
    </style>
}

@section Scripts {
    <script src="~/vendor/tom-select/tom-select.complete.min.js" defer></script>
    <script src="~/js/empleados-form.js" defer></script>
}
