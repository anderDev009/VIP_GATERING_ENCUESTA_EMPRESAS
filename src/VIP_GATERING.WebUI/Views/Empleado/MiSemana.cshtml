@model VIP_GATERING.WebUI.Models.SemanaEmpleadoVM
@{
    ViewData["Title"] = "Mi semana";
    var noHabilitado = (bool?)ViewBag.NoHabilitado ?? false;
    var tituloSemana = Model.SemanaClave == "actual" ? "Menu semana actual" : "Menu semana proxima";
    var empresaNombre = string.IsNullOrWhiteSpace(Model.EmpresaNombre) ? "Empresa asignada" : Model.EmpresaNombre;
    var filialNombre = string.IsNullOrWhiteSpace(Model.SucursalNombre) ? "Filial asignada" : Model.SucursalNombre;

    var origenEtiqueta = string.IsNullOrWhiteSpace(Model.OrigenMenu) ? "General" : Model.OrigenMenu;
    var localizacionEtiqueta = string.IsNullOrWhiteSpace(Model.LocalizacionEntregaNombre)
        ? "Sin localizacion"
        : Model.LocalizacionEntregaNombre;
    var letrasOpciones = new[] { "A", "B", "C", "D", "E" };
    var diasConIndice = Model.Dias.Select((d, idx) => new { Dia = d, Index = idx }).ToList();
    var grupos = diasConIndice.GroupBy(x => string.IsNullOrWhiteSpace(x.Dia.HorarioNombre) ? "General" : x.Dia.HorarioNombre!).ToList();
    var grupoInicial = grupos.FirstOrDefault();
    var progressTotal = grupoInicial?.Count() ?? 0;
    var progressSelected = grupoInicial?.Count(x => x.Dia.Seleccion != null) ?? 0;
}

<section class="page-panel space-y-4">
    <div class="meta-row">
        <span class="meta-pill meta-pill--accent">VIP</span>
        <span class="meta-pill">Empresa: @empresaNombre</span>
        <span class="meta-pill meta-pill--ghost">Filial: @filialNombre</span>
        <span class="meta-pill">Localizacion: @localizacionEtiqueta</span>
        @if (!string.IsNullOrWhiteSpace(Model.EmpleadoCodigo))
        {
            <span class="meta-pill meta-pill--ghost">Codigo empleado: @Model.EmpleadoCodigo</span>
        }
    </div>

    <div class="week-banner">
        <div class="week-banner__main">
            <span class="week-dot" aria-hidden="true"></span>
            <div>
                <p class="week-banner__eyebrow">MEN&Uacute; DE LA SEMANA</p>
                <p class="week-banner__title">Lunes @Model.FechaInicio.ToString("dd") - Viernes @Model.FechaTermino.ToString("dd 'de' MMMM yyyy")</p>
                @if (!string.IsNullOrWhiteSpace(Model.NotaVentana))
                {
                    <p class="week-banner__subtitle">@Model.NotaVentana</p>
                }
            </div>
        </div>
        <span class="week-banner__badge">@tituloSemana</span>
    </div>

    @if (!Model.MenuDisponible)
    {
        <div class="alert alert-info mb-4 flex items-start gap-3">
            <span class="alert__icon" aria-hidden="true">!</span>
            <div>
                <p class="font-semibold text-slate-900">Sin men&uacute; configurado para la semana actual</p>
                <p class="text-sm text-slate-500">@Model.MensajeSinMenu ?? "Cuando el administrador publique el men&uacute;, podr&aacute;s acceder a &eacute;l desde esta pantalla."</p>
            </div>
        </div>
    }

    @if (Model.SemanasDisponibles != null && Model.SemanasDisponibles.Any())
    {
        <form method="get" asp-action="MiSemana" class="control-panel">
            <div class="control-field">
                <label>Ver semana</label>
                <div class="control-input">
                    <select name="semana" onchange="this.form.submit()">
                        @foreach (var s in Model.SemanasDisponibles)
                        {
                            if (s.Clave == Model.SemanaClave)
                            {
                                <option value="@s.Clave" selected>@s.Etiqueta</option>
                            }
                            else
                            {
                                <option value="@s.Clave">@s.Etiqueta</option>
                            }
                        }
                    </select>
                </div>
            </div>
            @if (Model.LocalizacionesEntregaDisponibles != null && Model.LocalizacionesEntregaDisponibles.Count > 0)
            {
                <div class="control-field">
                    <label>Localizaci&oacute;n</label>
                    <div class="control-input">
                        <select name="localizacionId" onchange="this.form.submit()">
                            @foreach (var s in Model.LocalizacionesEntregaDisponibles)
                            {
                                if (s.id == Model.LocalizacionEntregaId)
                                {
                                    <option value="@s.id" selected>@s.nombre</option>
                                }
                                else
                                {
                                    <option value="@s.id">@s.nombre</option>
                                }
                            }
                        }
                    </select>
                </div>
                <p class="control-hint">La localizaci&oacute;n se guarda para toda la semana.</p>
            </div>
            }
            <noscript>
                <button class="btn-primary btn-sm">Cambiar</button>
            </noscript>
        </form>
    }
</section>

@if (noHabilitado)
{
    <div class="alert alert-warning mb-4">
        Tu cuenta no esta habilitada para seleccionar platos. Si crees que es un error, contacta a tu administrador.
    </div>
}
else if (Model.Bloqueado)
{
    <div class="alert alert-locked mb-4">
        @(string.IsNullOrWhiteSpace(Model.MensajeBloqueo) ? "Ya registraste tu menu de esta semana. No se puede modificar." : Model.MensajeBloqueo)
    </div>
}

@if (Model.MenuDisponible)
{
<section class="page-panel space-y-3 mb-5">
    <div class="panel-header">
        <div>
            <p class="eyebrow">Progreso</p>
            <p class="panel-title" id="progress-text">@progressSelected/@progressTotal platos escogidos</p>
        </div>
        <span class="chip chip--success" id="summary-total-chip">Total a pagar: @Model.TotalEmpleado.ToString("C")</span>
    </div>
    <div class="progress-track">
        @{ var pct = progressTotal == 0 ? 0 : (int)(100.0 * progressSelected / progressTotal); }
        <div style="width:@pct%" class="progress-bar"></div>
    </div>
    @if (!Model.Bloqueado && !noHabilitado)
    {
        <div class="panel-subtitle">Sigue completando tus dias pendientes.</div>
    }
</section>

<form asp-action="GuardarSemana" method="post" class="page-panel space-y-5" id="form-menu" data-localizacion="@Model.LocalizacionEntregaNombre">
    @Html.AntiForgeryToken()
    <input type="hidden" name="MenuId" value="@Model.MenuId" />
    <input type="hidden" name="SemanaClave" value="@Model.SemanaClave" />
    <input type="hidden" name="SucursalEntregaId" value="@Model.SucursalEntregaId" />
    <input type="hidden" name="LocalizacionEntregaId" value="@Model.LocalizacionEntregaId" />

    <div class="panel-header">
        <div>
            <p class="eyebrow">Selecciona tus platos</p>
            <p class="panel-subtitle">Formato en tabla para comparar de un vistazo.</p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button type="button" id="clear-all" class="btn-soft @((Model.Bloqueado || noHabilitado) ? "opacity-60 cursor-not-allowed" : "")" @((Model.Bloqueado || noHabilitado) ? "disabled" : "")>Borrar todo</button>
            <button class="btn-primary" @((Model.Bloqueado || noHabilitado) ? "disabled" : "")>Guardar seleccion</button>
        </div>
    </div>

    <div class="tab-switch">
        <div class="tab-switch__label">Tandas</div>
        <div class="tab-switch__group" id="tabs-horario">
            @for (var gi = 0; gi < grupos.Count; gi++)
            {
                var g = grupos[gi];
                var tabId = $"tab-{gi}";
                <button type="button" class="tab-pill" data-tab-target="@tabId">@g.Key</button>
            }
        </div>
    </div>

    @for (var gi = 0; gi < grupos.Count; gi++)
    {
        var g = grupos[gi];
        var tabId = $"tab-{gi}";
        var maxOpciones = g.Max(x => x.Dia.OpcionesMaximas <= 0 ? 3 : x.Dia.OpcionesMaximas);
        <div id="@tabId" class="tab-panel @(gi == 0 ? "is-active" : "") space-y-3" data-tab-panel>
            <table class="menu-table">
                <thead>
                    <tr>
                        <th>D&iacute;a</th>
                        @for (var col = 0; col < maxOpciones; col++)
                        {
                            <th>Plato @letrasOpciones[col]</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in g)
                    {
                        var d = item.Dia;
                        var i = item.Index;
                        var opcionesDia = new[]
                        {
                            new { Clave = "A", Nombre = d.A, Imagen = d.ImagenA, Precio = d.PrecioEmpleadoA },
                            new { Clave = "B", Nombre = d.B, Imagen = d.ImagenB, Precio = d.PrecioEmpleadoB },
                            new { Clave = "C", Nombre = d.C, Imagen = d.ImagenC, Precio = d.PrecioEmpleadoC },
                            new { Clave = "D", Nombre = d.D, Imagen = d.ImagenD, Precio = d.PrecioEmpleadoD },
                            new { Clave = "E", Nombre = d.E, Imagen = d.ImagenE, Precio = d.PrecioEmpleadoE }
                        }.Take(d.OpcionesMaximas <= 0 ? 3 : d.OpcionesMaximas).ToList();
                        <tr>
                            <td class="menu-daycell">
                                <div class="menu-day-title">
                                    <span>@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetDayName(d.DiaSemana)</span>
                                    <span class="menu-day-meta">
                                        <span class="icon-dot icon-dot--teal"></span>
                                        @d.HorarioNombre
                                    </span>
                                </div>
                                <div class="menu-day-actions">
                                    <button type="button"
                                            class="btn-soft btn-soft--danger clear-day @((Model.Bloqueado || noHabilitado || !d.Editable) ? "opacity-60 cursor-not-allowed" : "")"
                                            data-day="@i"
                                            @((Model.Bloqueado || noHabilitado || !d.Editable) ? "disabled" : "")>
                                        Borrar seleccion
                                    </button>
                                    <input type="hidden" name="Dias[@i].OpcionMenuId" value="@d.OpcionMenuId" />
                                </div>
                            </td>
                            @for (var col = 0; col < maxOpciones; col++)
                            {
                                var opc = col < opcionesDia.Count ? opcionesDia[col] : null;
                                var seleccionada = opc != null && d.Seleccion == opc.Clave[0];
                                var disabled = Model.Bloqueado || noHabilitado || !d.Editable || opc == null || string.IsNullOrWhiteSpace(opc.Nombre);
                                <td class="menu-option-cell">
                                    @if (opc == null || string.IsNullOrWhiteSpace(opc.Nombre))
                                    {
                                        <div class="menu-option-empty">Sin definir</div>
                                    }
                                    else
                                    {
                                        <label class="option-card @((seleccionada) ? "option-card--active" : "") @((disabled) ? "option-card--disabled" : "")">
                                            <input type="radio"
                                                   name="Dias[@i].Seleccion"
                                                   value="@opc.Clave"
                                                   class="option-card__input"
                                                   data-price="@(opc.Precio?.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture) ?? "0")"
                                                   @(seleccionada ? "checked" : "")
                                                   @((disabled) ? "disabled" : "") />
                                            <div class="option-card__content">
                                                <div class="option-card__header">
                                                    <span class="chip chip--muted">Plato @opc.Clave</span>
                                                    <span class="chip chip--success selected-chip @(seleccionada ? "" : "hidden")">Seleccionado</span>
                                                    @if (!seleccionada && !d.Editable)
                                                    {
                                                        <span class="chip chip--soft">Cerrado</span>
                                                    }
                                                </div>
                                                <div class="option-card__title">@opc.Nombre</div>
                                                <div class="option-card__meta">@d.HorarioNombre</div>
                                            </div>
                                            @if (!string.IsNullOrWhiteSpace(opc.Imagen))
                                            {
                                                <div class="option-card__thumb">
                                                    <img src="@opc.Imagen" alt="Plato @opc.Clave de @d.HorarioNombre" />
                                                </div>
                                            }
                                        </label>
                                    }
                                </td>
                            }
                        </tr>
                        @if (Model.AdicionalesDisponibles != null && Model.AdicionalesDisponibles.Count > 0)
                        {
                            <tr>
                                <td class="menu-daycell"></td>
                                <td colspan="@maxOpciones" class="menu-option-cell">
                                    <div class="addon-field">
                                        <label>Adicional (se cobra 100%)</label>
                                        <select name="Dias[@i].AdicionalOpcionId" class="w-full"
                                                @((Model.Bloqueado || noHabilitado || !d.Editable) ? "disabled" : "")>
                                            <option value="" data-price="0">-- Sin adicional --</option>
                                            @foreach (var a in Model.AdicionalesDisponibles)
                                            {
                                                var price = a.Precio.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture);
                                                if (d.AdicionalOpcionId != null && d.AdicionalOpcionId.Value == a.Id)
                                                {
                                                    <option value="@a.Id" data-price="@price" selected>@a.Nombre (@a.Precio.ToString("C"))</option>
                                                }
                                                else
                                                {
                                                    <option value="@a.Id" data-price="@price">@a.Nombre (@a.Precio.ToString("C"))</option>
                                                }
                                            }
                                        </select>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }

    <div class="summary-grid">
        <div class="summary-card">
            <p class="eyebrow">Platos seleccionados</p>
            <p class="summary-value" id="summary-dias">@Model.RespuestasCount</p>
            <p class="summary-hint">de @Model.TotalDias dias</p>
        </div>
        <div class="summary-card summary-card--accent">
            <p class="eyebrow">Total empleado</p>
            <p class="summary-value" id="summary-total-empleado">@Model.TotalEmpleado.ToString("C")</p>
            <p class="summary-hint">Principal + opcionales</p>
        </div>
        <div class="summary-card">
            <p class="eyebrow">Adicionales 100%</p>
            <p class="summary-value" id="summary-adicionales">@((0m).ToString("C"))</p>
            <p class="summary-hint">Solo cargos de empleado</p>
        </div>
    </div>

    <div class="form-actions">
        <button class="btn-primary btn-lg" @((Model.Bloqueado || noHabilitado) ? "disabled" : "")>Grabar seleccion</button>
    </div>
    </form>
}
else
{
    <section class="page-panel space-y-4">
        <p class="text-slate-600 font-medium">Todav&iacute;a no se ha publicado el men&uacute; de esta semana. Puedes consultar con tu administrador o volver m&aacute;s tarde.</p>
        <div class="flex flex-wrap gap-3">
            <a asp-controller="Menu" asp-action="Administrar" class="btn-outline">Ir a Administrar</a>
            <a asp-action="MiSemana" asp-route-semana="actual" class="btn-primary">Refrescar</a>
        </div>
    </section>
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    (() => {
        const updateDaySelection = (dayIndex) => {
            if (dayIndex === null || dayIndex === undefined) return;
            const radios = document.querySelectorAll(`input[name="Dias[${dayIndex}].Seleccion"]`);
            radios.forEach(r => {
                const card = r.closest('.option-card');
                if (!card) return;
                const selectedChip = card.querySelector('.selected-chip');
                const isChecked = r.checked;
                card.classList.toggle('option-card--active', isChecked);
                if (selectedChip) selectedChip.classList.toggle('hidden', !isChecked);
            });
        };

        const handleRadioChange = (radio) => {
            const name = radio.getAttribute('name') || '';
            const match = name.match(/Dias\[(\d+)\]/);
            if (!match) return;
            const dayIndex = match[1];
            const radios = document.querySelectorAll(`input[name="${name}"]`);
            radios.forEach(r => r.checked = (r === radio));
            updateDaySelection(dayIndex);
        };

        document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(radio => {
            radio.addEventListener('change', () => handleRadioChange(radio));
        });

        const clearButtons = document.querySelectorAll('.clear-day');
        clearButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const dayIndex = btn.getAttribute('data-day');
                if (dayIndex === null) return;
                const radios = document.querySelectorAll(`input[name="Dias[${dayIndex}].Seleccion"]`);
                radios.forEach(r => r.checked = false);
                const adicional = document.querySelector(`select[name="Dias[${dayIndex}].AdicionalOpcionId"]`);
                if (adicional) adicional.value = '';
                updateDaySelection(dayIndex);
                recomputeTotals();
            });
        });
        const clearAll = document.getElementById('clear-all');
        if (clearAll) {
            clearAll.addEventListener('click', () => {
                document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => r.checked = false);
                document.querySelectorAll('select[name*="Dias"][name$=".AdicionalOpcionId"]').forEach(s => s.value = '');
                const dayNames = new Set();
                document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => {
                    const match = (r.getAttribute('name') || '').match(/Dias\[(\d+)\]/);
                    if (match) dayNames.add(match[1]);
                });
                dayNames.forEach(idx => updateDaySelection(idx));
                recomputeTotals();
            });
        }
        const progressText = document.getElementById('progress-text');
        const progressBar = document.querySelector('.progress-bar');
        const updateProgress = () => {
            if (!progressText || !progressBar) return;
            const activePanel = document.querySelector('[data-tab-panel].is-active') || document.querySelector('[data-tab-panel]');
            if (!activePanel) return;
            const dayIndices = new Set();
            activePanel.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => {
                const match = (r.getAttribute('name') || '').match(/Dias\[(\d+)\]/);
                if (match) dayIndices.add(match[1]);
            });
            let selectedCount = 0;
            dayIndices.forEach(idx => {
                const selected = activePanel.querySelector(`input[name="Dias[${idx}].Seleccion"]:checked`);
                if (selected) selectedCount += 1;
            });
            const totalDays = dayIndices.size;
            progressText.textContent = `${selectedCount}/${totalDays} platos escogidos`;
            const pct = totalDays === 0 ? 0 : Math.round((selectedCount / totalDays) * 100);
            progressBar.style.width = `${pct}%`;
        };

        const recomputeTotals = () => {
            let diasSeleccionados = 0;
            let totalPrincipal = 0;
            let totalAdicional = 0;

            const dayIndices = new Set();
            document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => {
                const match = (r.getAttribute('name') || '').match(/Dias\[(\d+)\]/);
                if (match) dayIndices.add(match[1]);
            });

            dayIndices.forEach(idx => {
                const selected = document.querySelector(`input[name="Dias[${idx}].Seleccion"]:checked`);
                if (selected) {
                    diasSeleccionados += 1;
                    const price = parseFloat(selected.getAttribute('data-price') || '0') || 0;
                    totalPrincipal += price;
                }
                const adicional = document.querySelector(`select[name="Dias[${idx}].AdicionalOpcionId"] option:checked`);
                if (adicional) {
                    const priceAd = parseFloat(adicional.getAttribute('data-price') || '0') || 0;
                    totalAdicional += priceAd;
                }
            });

            const fmt = (v) => v.toLocaleString('es-DO', { style: 'currency', currency: 'DOP' });
            const diasNode = document.getElementById('summary-dias');
            const empNode = document.getElementById('summary-total-empleado');
            const adNode = document.getElementById('summary-adicionales');
            const chipNode = document.getElementById('summary-total-chip');
            if (diasNode) diasNode.textContent = diasSeleccionados.toString();
            if (empNode) empNode.textContent = fmt(totalPrincipal + totalAdicional);
            if (adNode) adNode.textContent = fmt(totalAdicional);
            if (chipNode) chipNode.textContent = `Total a pagar: ${fmt(totalPrincipal + totalAdicional)}`;
            updateProgress();
        };

        const tabButtons = document.querySelectorAll('.tab-pill');
        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetId = btn.getAttribute('data-tab-target');
                if (!targetId) return;
                document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.remove('is-active'));
                const target = document.getElementById(targetId);
                if (target) target.classList.add('is-active');
                tabButtons.forEach(b => b.classList.remove('is-active'));
                btn.classList.add('is-active');
                updateProgress();
            });
        });
        if (tabButtons.length > 0) tabButtons[0].classList.add('is-active');

        // Inicializa el estado visual segun seleccion inicial
        const initialDays = new Set();
        document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => {
            const match = (r.getAttribute('name') || '').match(/Dias\[(\d+)\]/);
            if (match) initialDays.add(match[1]);
        });
        initialDays.forEach(idx => updateDaySelection(idx));

        // Eventos para totales en tiempo real
        document.querySelectorAll('input[type="radio"][name*="Dias"]').forEach(r => {
            r.addEventListener('change', recomputeTotals);
        });
        document.querySelectorAll('select[name*="Dias"][name$=".AdicionalOpcionId"]').forEach(s => {
            s.addEventListener('change', recomputeTotals);
        });
        recomputeTotals();

        const form = document.getElementById('form-menu');
        if (form) {
            form.addEventListener('submit', (event) => {
                if (form.dataset.confirmed === '1') return;
                event.preventDefault();
                const seleccionadas = document.querySelectorAll('input[type="radio"][name*="Dias"]:checked').length;
                const loc = (form.dataset.localizacion || '').trim();
                const locLabel = loc ? `Localizacion: ${loc}` : 'Localizacion: sin asignar';
                const resumen = `Platos seleccionados: ${seleccionadas}<br>${locLabel}`;
                Swal.fire({
                    title: 'Confirmar menu',
                    html: `Estas por guardar tu menu.<br>${resumen}`,
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'Confirmar',
                    cancelButtonText: 'Cancelar'
                }).then(result => {
                    if (result.isConfirmed) {
                        form.dataset.confirmed = '1';
                        form.submit();
                    }
                });
            });
        }
    })();
</script>






