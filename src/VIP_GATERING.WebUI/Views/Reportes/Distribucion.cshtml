@model VIP_GATERING.WebUI.Models.Reportes.DistribucionVM
@{
    ViewData["Title"] = "Distribucion";
    var showData = string.IsNullOrWhiteSpace(Model.MensajeValidacion);
    var isRRHH = User.IsInRole("RRHH");

    var empresaNombre = Model.Empresas.FirstOrDefault(e => e.Id == Model.EmpresaId)?.Nombre ?? "Todas";
    var sucursalNombre = Model.Sucursales.FirstOrDefault(s => s.Id == Model.SucursalId)?.Nombre ?? "Todas";
    var empleadoNombre = Model.Empleados.FirstOrDefault(e => e.Id == Model.EmpleadoId)?.Nombre
        ?? Model.Empleados.FirstOrDefault(e => e.Id == Model.EmpleadoId)?.Codigo
        ?? "Todos";
    var localizacionNombre = Model.Localizaciones.FirstOrDefault(l => l.Id == Model.LocalizacionId)?.Nombre ?? "Todas";
    var tandaNombre = Model.Horarios.FirstOrDefault(h => h.Id == Model.HorarioId)?.Nombre ?? "Todas";
    var horaAlmuerzoNombre = !string.IsNullOrWhiteSpace(Model.HoraAlmuerzo) ? Model.HoraAlmuerzo : "Todas";
    var vistaKey = (ViewContext.HttpContext.Request.Query["vista"].ToString() ?? "resumen").Trim().ToLowerInvariant();
    if (string.IsNullOrWhiteSpace(vistaKey))
    {
        vistaKey = "resumen";
    }
    if (isRRHH && vistaKey != "resumen" && vistaKey != "detalle")
    {
        vistaKey = "resumen";
    }
}

<h1 class="text-xl font-semibold mb-4">Distribucion desde @Model.Inicio.ToString("dd/MM/yyyy") hasta @Model.Fin.ToString("dd/MM/yyyy")</h1>

@if (!showData)
{
    <div class="mb-4 rounded-2xl border border-amber-100 bg-amber-50 px-4 py-3 text-amber-700">
        @Model.MensajeValidacion
    </div>
}

<form method="get" class="mb-6 grid gap-4 md:grid-cols-4 items-end">
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Desde</label>
        <input type="date" name="desde" value="@Model.Inicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100" />
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Hasta</label>
        <input type="date" name="hasta" value="@Model.Fin.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100" />
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Empresa</label>
        <select name="empresaId" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100">
            <option value="" selected="@(Model.EmpresaId == null ? "selected" : null)">Todas</option>
            @foreach (var e in Model.Empresas)
            {
                <option value="@e.Id" selected="@(Model.EmpresaId == e.Id ? "selected" : null)">@e.Nombre</option>
            }
        </select>
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Filial</label>
        <select name="sucursalId" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100">
            <option value="" selected="@(Model.SucursalId == null ? "selected" : null)">Todas</option>
            @foreach (var s in Model.Sucursales)
            {
                <option value="@s.Id" selected="@(Model.SucursalId == s.Id ? "selected" : null)">@s.Nombre</option>
            }
        </select>
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Empleado</label>
        <select name="empleadoId" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100">
            <option value="" selected="@(Model.EmpleadoId == null ? "selected" : null)">Todos</option>
            @foreach (var e in Model.Empleados)
            {
                var nombre = !string.IsNullOrWhiteSpace(e.Nombre) ? e.Nombre : e.Codigo;
                <option value="@e.Id" selected="@(Model.EmpleadoId == e.Id ? "selected" : null)">@nombre</option>
            }
        </select>
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Localizacion</label>
        <select name="localizacionId" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100">
            <option value="" selected="@(Model.LocalizacionId == null ? "selected" : null)">Todas</option>
            @foreach (var l in Model.Localizaciones)
            {
                <option value="@l.Id" selected="@(Model.LocalizacionId == l.Id ? "selected" : null)">@l.Nombre</option>
            }
        </select>
        <div class="mt-1 text-xs text-slate-400">Si filtras por empleado, la localizacion es opcional.</div>
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Tanda</label>
        <select name="horarioId" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100" @((Model.EmpresaId == null && Model.SucursalId == null) ? "disabled" : "")>
            <option value="" selected="@(Model.HorarioId == null ? "selected" : null)">Todas</option>
            @foreach (var h in Model.Horarios)
            {
                <option value="@h.Id" selected="@(Model.HorarioId == h.Id ? "selected" : null)">@h.Nombre</option>
            }
        </select>
        @if (Model.EmpresaId == null && Model.SucursalId == null)
        {
            <div class="mt-1 text-xs text-slate-400">Selecciona empresa o filial para cargar horarios.</div>
        }
    </div>
    <div class="md:col-span-2">
        <label class="text-xs uppercase tracking-widest text-slate-400">Hora almuerzo</label>
        <select name="horaAlmuerzo" class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-teal-100" @(Model.HorarioId == null ? "disabled" : "")>
            <option value="" selected="@(string.IsNullOrWhiteSpace(Model.HoraAlmuerzo) ? "selected" : null)">Todas</option>
            @foreach (var h in Model.HorasAlmuerzo)
            {
                <option value="@h" selected="@(Model.HoraAlmuerzo == h ? "selected" : null)">@h</option>
            }
        </select>
        @if (Model.HorarioId == null)
        {
            <div class="mt-1 text-xs text-slate-400">Selecciona una tanda para cargar horas.</div>
        }
        else if (!Model.HorasAlmuerzo.Any())
        {
            <div class="mt-1 text-xs text-slate-400">No hay horas registradas en el rango.</div>
        }
    </div>
    <div class="flex gap-3 md:col-span-4">
        <button type="submit" class="btn-primary">Filtrar</button>
        <a class="btn-outline" asp-action="Distribucion">Limpiar</a>
        @if (showData)
        {
            <a class="btn-outline" data-export-excel asp-action="DistribucionExcel" asp-route-empresaId="@Model.EmpresaId" asp-route-sucursalId="@Model.SucursalId" asp-route-empleadoId="@Model.EmpleadoId" asp-route-localizacionId="@Model.LocalizacionId" asp-route-horarioId="@Model.HorarioId" asp-route-horaAlmuerzo="@Model.HoraAlmuerzo" asp-route-desde='@Model.Inicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")' asp-route-hasta='@Model.Fin.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")'>Exportar Excel</a>
            <a class="btn-outline" data-export-csv asp-action="DistribucionCsv" asp-route-empresaId="@Model.EmpresaId" asp-route-sucursalId="@Model.SucursalId" asp-route-empleadoId="@Model.EmpleadoId" asp-route-localizacionId="@Model.LocalizacionId" asp-route-horarioId="@Model.HorarioId" asp-route-horaAlmuerzo="@Model.HoraAlmuerzo" asp-route-desde='@Model.Inicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")' asp-route-hasta='@Model.Fin.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")'>Exportar CSV</a>
            <a class="btn-outline" data-export-pdf asp-action="DistribucionPdf" asp-route-empresaId="@Model.EmpresaId" asp-route-sucursalId="@Model.SucursalId" asp-route-empleadoId="@Model.EmpleadoId" asp-route-localizacionId="@Model.LocalizacionId" asp-route-horarioId="@Model.HorarioId" asp-route-horaAlmuerzo="@Model.HoraAlmuerzo" asp-route-desde='@Model.Inicio.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")' asp-route-hasta='@Model.Fin.ToDateTime(TimeOnly.MinValue).ToString("yyyy-MM-dd")'>Exportar PDF</a>
        }
    </div>
    @if (showData)
    {
        <div class="md:col-span-4 text-sm text-slate-600">
            <span class="font-semibold">Filtros:</span>
            Fecha @Model.Inicio.ToString("dd/MM/yyyy") a @Model.Fin.ToString("dd/MM/yyyy"),
            Empresa: @empresaNombre,
            Filial: @sucursalNombre,
            Empleado: @empleadoNombre,
            Localizacion: @localizacionNombre,
            Tanda: @tandaNombre,
            Hora almuerzo: @horaAlmuerzoNombre.
        </div>
        @if (!isRRHH)
        {
            <div class="md:col-span-4 text-right space-y-1 border-t border-slate-200 pt-3" id="reportes-totales">
                <div class="text-sm text-slate-600">Total base: <span class="font-semibold">@Model.TotalBase.ToString("C")</span></div>
                <div class="text-sm text-slate-600">ITBIS: <span class="font-semibold">@Model.TotalItbis.ToString("C")</span></div>
                <div class="text-sm text-slate-600">Total general: <span class="font-semibold">@Model.TotalGeneral.ToString("C")</span></div>
                <div class="text-sm text-slate-600">Empresa paga: <span class="font-semibold">@Model.TotalEmpresa.ToString("C")</span></div>
                <div class="text-sm text-slate-600">Empleado paga: <span class="font-semibold">@Model.TotalEmpleado.ToString("C")</span></div>
            </div>
        }
    }
    <input type="hidden" name="vista" value="@vistaKey" />
    <input type="hidden" name="_" value="@DateTime.UtcNow.Ticks" />
</form>

@if (showData)
{
    <div class="tab-switch tab-switch--panel mb-4">
        <div class="tab-switch__label">Vista</div>
        <div class="tab-switch__group">
            <button type="button" class="tab-pill @(vistaKey == "resumen" ? "is-active" : "")" data-tab-target="tab-resumen">Resumen por filial</button>
            <button type="button" class="tab-pill @(vistaKey == "detalle" ? "is-active" : "")" data-tab-target="tab-detalle-pedidos">Detalle por empleado</button>
            @if (!isRRHH)
            {
                <button type="button" class="tab-pill @(vistaKey == "localizacion" ? "is-active" : "")" data-tab-target="tab-localizacion">Distribucion por localizacion</button>
                <button type="button" class="tab-pill @(vistaKey == "distribucion-detalle" ? "is-active" : "")" data-tab-target="tab-distribucion-detalle">Detalle distribucion</button>
                <button type="button" class="tab-pill @(vistaKey == "cocina" ? "is-active" : "")" data-tab-target="tab-cocina">Cocina</button>
            }
        </div>
    </div>

    <div id="tab-resumen" class="tab-panel @(vistaKey == "resumen" ? "is-active" : "") space-y-3" data-tab-panel>
        <div class="report-scroll">
        <table>
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Filial</th>
                <th class="text-right">Base</th>
                <th class="text-right">ITBIS</th>
                <th class="text-right">Total</th>
                <th class="text-right">ITBIS empresa</th>
                <th class="text-right">ITBIS empleado</th>
                <th class="text-right">Monto adicional</th>
                <th class="text-right">ITBIS adicional</th>
                <th class="text-right">Empresa paga</th>
                <th class="text-right">Empleado paga</th>
            </tr>
            </thead>
            <tbody>
            @{
                var resumenPorDia = Model.ResumenFiliales
                    .GroupBy(r => r.Fecha)
                    .OrderBy(g => g.Key);
            }
            @foreach (var g in resumenPorDia)
            {
                foreach (var r in g.OrderBy(x => x.Filial))
                {
                    <tr>
                        <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                        <td>@r.Filial</td>
                        <td class="text-right">@r.Base.ToString("C")</td>
                        <td class="text-right">@r.Itbis.ToString("C")</td>
                        <td class="text-right">@r.Total.ToString("C")</td>
                        <td class="text-right">@r.ItbisEmpresa.ToString("C")</td>
                        <td class="text-right">@r.ItbisEmpleado.ToString("C")</td>
                        <td class="text-right">@r.MontoAdicional.ToString("C")</td>
                        <td class="text-right">@r.ItbisAdicional.ToString("C")</td>
                        <td class="text-right">@r.EmpresaPaga.ToString("C")</td>
                        <td class="text-right">@r.EmpleadoPaga.ToString("C")</td>
                    </tr>
                }
            }
            @if (Model.ResumenFiliales.Count > 0)
            {
                <tr class="bg-slate-100 font-semibold">
                    <td></td>
                    <td>Total general</td>
                    <td class="text-right">@Model.TotalBase.ToString("C")</td>
                    <td class="text-right">@Model.TotalItbis.ToString("C")</td>
                    <td class="text-right">@Model.TotalGeneral.ToString("C")</td>
                    <td class="text-right">@Model.ResumenFiliales.Sum(x => x.ItbisEmpresa).ToString("C")</td>
                    <td class="text-right">@Model.ResumenFiliales.Sum(x => x.ItbisEmpleado).ToString("C")</td>
                    <td class="text-right">@Model.ResumenFiliales.Sum(x => x.MontoAdicional).ToString("C")</td>
                    <td class="text-right">@Model.ResumenFiliales.Sum(x => x.ItbisAdicional).ToString("C")</td>
                    <td class="text-right">@Model.TotalEmpresa.ToString("C")</td>
                    <td class="text-right">@Model.TotalEmpleado.ToString("C")</td>
                </tr>
            }
            </tbody>
        </table>
        </div>
    </div>

    <div id="tab-detalle-pedidos" class="tab-panel @(vistaKey == "detalle" ? "is-active" : "") space-y-3" data-tab-panel>
        <div class="report-scroll">
        <table>
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Filial</th>
                <th>Localizacion</th>
                <th>Empleado</th>
                <th>Tanda</th>
                <th>Opcion</th>
                <th>Seleccion</th>
                <th class="text-right">Base</th>
                <th class="text-right">ITBIS</th>
                <th class="text-right">Total</th>
                <th class="text-right">Empresa paga</th>
                <th class="text-right">Empleado paga</th>
                <th class="text-right">ITBIS empresa</th>
                <th class="text-right">ITBIS empleado</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.DetalleEmpleados)
            {
                var empleado = string.IsNullOrWhiteSpace(r.EmpleadoCodigo) ? r.Empleado : $"{r.EmpleadoCodigo} - {r.Empleado}";
                <tr>
                    <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                    <td>@r.Filial</td>
                    <td>@r.Localizacion</td>
                    <td>@empleado</td>
                    <td>@r.Tanda</td>
                    <td>@r.Opcion</td>
                    <td>@r.Seleccion</td>
                    <td class="text-right">@r.Base.ToString("C")</td>
                    <td class="text-right">@r.Itbis.ToString("C")</td>
                    <td class="text-right">@r.Total.ToString("C")</td>
                    <td class="text-right">@r.EmpresaPaga.ToString("C")</td>
                    <td class="text-right">@r.EmpleadoPaga.ToString("C")</td>
                    <td class="text-right">@r.ItbisEmpresa.ToString("C")</td>
                    <td class="text-right">@r.ItbisEmpleado.ToString("C")</td>
                </tr>
            }
            </tbody>
        </table>
        </div>
    </div>

    <div id="tab-localizacion" class="tab-panel @(vistaKey == "localizacion" ? "is-active" : "") space-y-3" data-tab-panel>
        <div class="report-scroll">
        <table>
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Filial</th>
                <th>Localizacion</th>
                <th>Opcion</th>
                <th>Seleccion</th>
                <th class="text-right">Cantidad</th>
                <th class="text-right">Monto total</th>
                <th class="text-right">Monto empresa</th>
                <th class="text-right">Monto empleado</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.PorLocalizacion)
            {
                <tr>
                    <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                    <td>@r.Filial</td>
                    <td>@r.Localizacion</td>
                    <td>@r.Opcion</td>
                    <td>@r.Seleccion</td>
                    <td class="text-right">@r.Cantidad</td>
                    <td class="text-right">@r.MontoTotal.ToString("C")</td>
                    <td class="text-right">@r.EmpresaPaga.ToString("C")</td>
                    <td class="text-right">@r.EmpleadoPaga.ToString("C")</td>
                </tr>
            }
            </tbody>
        </table>
        </div>
    </div>

    @if (!isRRHH)
    {
    <div id="tab-distribucion-detalle" class="tab-panel @(vistaKey == "distribucion-detalle" ? "is-active" : "") space-y-3" data-tab-panel>
        <div class="report-scroll">
        <table>
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Filial</th>
                <th>Localizacion</th>
                <th>Opcion 1</th>
                <th>Opcion 2</th>
                <th>Opcion 3</th>
                <th>Opcion 4</th>
                <th>Opcion 5</th>
                <th>Adicional</th>
                <th>Total opcion</th>
                <th>Total adic</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.PorLocalizacionCocina)
            {
                var detalles = Model.PorLocalizacionCocinaDetalle
                    .Where(d => d.Fecha == r.Fecha && d.Filial == r.Filial && d.Localizacion == r.Localizacion)
                    .ToList();
                <tr>
                    <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                    <td>@r.Filial</td>
                    <td>@r.Localizacion</td>
                    <td class="text-right">@r.Opcion1</td>
                    <td class="text-right">@r.Opcion2</td>
                    <td class="text-right">@r.Opcion3</td>
                    <td class="text-right">@r.Opcion4</td>
                    <td class="text-right">@r.Opcion5</td>
                    <td class="text-right">@r.Adicionales</td>
                    <td class="text-right">@r.TotalOpciones</td>
                    <td class="text-right">@r.Adicionales</td>
                </tr>
                @if (detalles.Count > 0)
                {
                    <tr>
                        <td class="text-sm font-semibold">Detalle</td>
                        <td class="text-sm text-slate-600">Filial</td>
                        <td class="text-sm text-slate-600">Fecha</td>
                        <td class="text-sm text-slate-600">Codigo</td>
                        <td class="text-sm text-slate-600">Nombre</td>
                        <td class="text-sm text-slate-600">Seleccion</td>
                        <td colspan="3" class="text-sm text-slate-600">Plato/Adicional</td>
                        <td></td>
                        <td></td>
                    </tr>
                    @foreach (var d in detalles)
                    {
                        <tr>
                            <td></td>
                            <td class="text-sm">@d.Filial</td>
                            <td class="text-sm">@d.Fecha.ToString("yyyy-MM-dd")</td>
                            <td class="text-sm">@d.EmpleadoCodigo</td>
                            <td class="text-sm">@d.EmpleadoNombre</td>
                            <td class="text-sm">@d.Seleccion</td>
                            <td colspan="3" class="text-sm">@d.Opcion</td>
                            <td></td>
                            <td></td>
                        </tr>
                    }
                }
            }
            </tbody>
        </table>
        </div>

        <div class="mt-6 grid gap-6 md:grid-cols-3 text-sm text-slate-600">
            <div>
                <div class="border-b border-slate-300 pb-2"></div>
                <div class="mt-2 text-center">Fecha entrega</div>
            </div>
            <div>
                <div class="border-b border-slate-300 pb-2"></div>
                <div class="mt-2 text-center">Recibido</div>
            </div>
            <div>
                <div class="border-b border-slate-300 pb-2"></div>
                <div class="mt-2 text-center">Entregado</div>
            </div>
        </div>
    </div>
    }

    @if (!isRRHH)
    {
    <div id="tab-cocina" class="tab-panel @(vistaKey == "cocina" ? "is-active" : "") space-y-3" data-tab-panel>
        <div class="report-scroll">
        <table>
            <thead>
            <tr>
                <th>Fecha</th>
                <th>Filial</th>
                <th>Localizacion</th>
                <th>Opcion 1</th>
                <th>Opcion 2</th>
                <th>Opcion 3</th>
                <th>Opcion 4</th>
                <th>Opcion 5</th>
                <th>Adicional</th>
                <th>Total opcion</th>
                <th>Total adic</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in Model.PorLocalizacionCocina)
            {
                <tr>
                    <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                    <td>@r.Filial</td>
                    <td>@r.Localizacion</td>
                    <td class="text-right">@r.Opcion1</td>
                    <td class="text-right">@r.Opcion2</td>
                    <td class="text-right">@r.Opcion3</td>
                    <td class="text-right">@r.Opcion4</td>
                    <td class="text-right">@r.Opcion5</td>
                    <td class="text-right">@r.Adicionales</td>
                    <td class="text-right">@r.TotalOpciones</td>
                    <td class="text-right">@r.Adicionales</td>
                </tr>
            }
            </tbody>
        </table>
        </div>
    </div>
    }
}

@section Scripts {
    <script src="~/js/reportes-distribucion.js" defer></script>
}
